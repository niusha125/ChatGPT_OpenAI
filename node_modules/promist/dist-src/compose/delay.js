import wait from "../create/wait.js";
import { asNew, intercept } from "../helpers/index.js"; // eslint-disable-next-line @typescript-eslint/explicit-function-return-type

export default function delay(ms, delayRejection = false) {
  const init = Date.now();

  const delayer = () => {
    const time = Date.now() - init;
    const remaining = Math.max(0, ms - time);
    return wait(remaining);
  };

  function trunk(promise, create) {
    return intercept(asNew(promise, create), px => {
      return px.then(val => delayer().then(() => val)).catch(err => {
        return delayRejection ? delayer().then(() => Promise.reject(err)) : Promise.reject(err);
      });
    });
  }

  return trunk;
}